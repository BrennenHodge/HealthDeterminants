function main(t,e){function n(t){t.x=t.y=0,t.dx=y,t.dy=x,t.depth=0}function r(t){return(t._children=t.values)?t.value=t.values.reduce(function(t,e){return t+r(e)},0):t.value}function a(t){t._children&&(A.nodes({_children:t._children}),t._children.forEach(function(e){e.x=t.x+e.x*t.dx,e.y=t.y+e.y*t.dy,e.dx*=t.dx,e.dy*=t.dy,e.parent=t,a(e)}))}function l(t){function e(t){if(!g&&t){g=!0;var e=l(t),r=n.transition().duration(750),a=e.transition().duration(750);v.domain([t.x,t.x+t.dx]),w.domain([t.y,t.y+t.dy]),k.style("shape-rendering",null),k.selectAll(".depth").sort(function(t,e){return t.depth-e.depth}),e.selectAll("text").style("fill-opacity",0),r.selectAll(".ptext").call(i).style("fill-opacity",0),r.selectAll(".ctext").call(c).style("fill-opacity",0),a.selectAll(".ptext").call(i).style("fill-opacity",1),a.selectAll(".ctext").call(c).style("fill-opacity",1),r.selectAll("rect").call(d),a.selectAll("rect").call(d),r.remove().each("end",function(){k.style("shape-rendering","crispEdges"),g=!1})}}_.datum(t.parent).on("click",e).select("text").text(o(t));var n=k.insert("g",".grandparent").datum(t).attr("class","depth"),r=n.selectAll("g").data(t._children).enter().append("g");r.filter(function(t){return t._children}).classed("children",!0).on("click",e);var a=r.selectAll(".child").data(function(t){return t._children||[t]}).enter().append("g");a.append("rect").attr("class","child").call(d),a.append("text").attr("class","ctext").text(function(t){return t.key}).call(c),r.append("rect").attr("class","parent").call(d);var u=r.append("text").attr("class","ptext").attr("dy",".75em");return u.append("tspan").text(function(t){return t.key}),u.call(i),r.selectAll("rect").style("fill",function(t){return"#e3e3e3"}),r}function i(t){t.selectAll("tspan").attr("x",function(t){return v(t.x)+6}),t.attr("x",function(t){return v(t.x)+6}).attr("y",function(t){return w(t.y)+6}).style("opacity",function(t){return this.getComputedTextLength()<v(t.x+t.dx)-v(t.x)?1:0})}function c(t){t.attr("x",function(t){return v(t.x+t.dx)-this.getComputedTextLength()-6}).attr("y",function(t){return w(t.y+t.dy)-6}).style("opacity",function(t){return this.getComputedTextLength()<v(t.x+t.dx)-v(t.x)?1:0})}function d(t){t.attr("x",function(t){return v(t.x)}).attr("y",function(t){return w(t.y)}).attr("width",function(t){return v(t.x+t.dx)-v(t.x)}).attr("height",function(t){return w(t.y+t.dy)-w(t.y)})}function o(t){return t.parent?o(t.parent)+" / "+t.key:t.key}var u,s=$.extend(!0,{},defaults,t),p=d3.format(s.format),h=s.rootname,f=s.margin;$("#chart").width(s.width).height(s.height+40);var y=s.width-f.left-f.right,x=s.height-f.top-f.bottom,g,m=d3.scale.category20c(),v=d3.scale.linear().domain([0,y]).range([0,y]),w=d3.scale.linear().domain([0,x]).range([0,x]),A=d3.layout.treemap().children(function(t,e){return e?null:t._children}).sort(function(t,e){return t.value-e.value}).ratio(x/y*.5*(1+Math.sqrt(5))).round(!1),k=d3.select("#chart").append("svg").attr("width",y+f.left+f.right).attr("height",x+f.bottom+f.top).append("g").attr("transform","translate("+f.left+","+f.top+")").style("shape-rendering","crispEdges"),_=k.append("g").attr("class","grandparent");if(_.append("rect").attr("y",-f.top).attr("width",y).attr("height",f.top),_.append("text").attr("x",6).attr("y",6-f.top).attr("dy",".75em"),u=e instanceof Array?{key:h,values:e}:e,n(u),r(u),a(u),console.log(u),l(u),window.parent!==window){var E=document.documentElement.scrollHeight||document.body.scrollHeight;window.parent.postMessage({height:E},"*")}}window.addEventListener("message",function(t){var e=t.data.opts,n=t.data.data;return main(e,n)});var defaults={margin:{top:24,right:0,bottom:0,left:0},rootname:"TOP",format:",d",width:1e3,height:600};d3.json("data/dataForTreemap.json",function(t,e){if(!t){console.log(e);var n=d3.nest().key(function(t){return t.grandgrandfather}).key(function(t){return t.grandfather}).key(function(t){return t.father}).entries(e);main({title:"Determinants of Health"},{key:"Patient",values:n})}});